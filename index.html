<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cena de Fin de AÃ±o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/webp" href="./assets/logo.webp" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1d3557, #457b9d);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container { width: 100%; max-width: 480px; }
    .logo { display: block; margin: 0 auto 15px; width: 100px; height: auto; }
    h2 { text-align: center; color: #fff; margin-bottom: 20px; }
    form {
      background: white; padding: 25px; border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); box-sizing: border-box;
    }
    label { display: block; margin-top: 12px; font-weight: bold; color: #333; }
    input, select, button {
      width: 100%; padding: 12px; margin-top: 5px;
      font-size: 16px; border: 1px solid #ccc; border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background: #1d3557; color: white; cursor: pointer;
      margin-top: 20px; transition: background 0.2s;
    }
    button:hover:not(:disabled) { background: #457b9d; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    .aviso-descuento {
      background: #ffaa82; padding: 15px; border-radius: 8px;
      margin-top: 20px;
    }
    .aviso-descuento h3 {
      margin: 0 0 10px; color: #000; font-size: 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .aviso-descuento h3::before { content: "ðŸš¨"; font-size: 22px; }
    .aviso-descuento p { font-size: 15px; margin: 5px 0; color: #000; line-height: 1.4; }
    .footer { text-align: center; margin-top: 20px; font-size: 14px; color: #cecece; }
  </style>
</head>
<body>
  <div class="container">
    <img src="./assets/logo-blanco.webp" alt="Logo UNSJ" class="logo" />
    <h2>ðŸŽ‰ Cena de Fin de AÃ±o ðŸŽ‰</h2>

    <form id="form">
      <label for="dni">DNI <small>(sin puntos ni espacios)</small></label>
      <input type="text" name="dni" id="dni" placeholder="Ej: 12345678" required />

      <label for="nombre">Nombre y Apellido</label>
      <input type="text" name="nombre" id="nombre" placeholder="Tu nombre completo" required />

      <label for="correo">Correo electrÃ³nico</label>
      <input type="email" name="correo" placeholder="tu@mail.com" required />

      <label for="lugar">Lugar de trabajo</label>
      <select name="lugar" id="lugar" required>
        <option value="" disabled selected>SeleccionÃ¡ tu lugar de trabajo</option>
        <option value="Rectorado">Rectorado</option>
        <option value="Facultad de Ciencias Exactas, FÃ­sicas y Naturales">Facultad de Ciencias Exactas, FÃ­sicas y Naturales</option>
        <option value="Facultad de IngenierÃ­a">Facultad de IngenierÃ­a</option>
        <option value="Facultad de Ciencias Sociales">Facultad de Ciencias Sociales</option>
        <option value="Facultad de FilosofÃ­a, Humanidades y Artes">Facultad de FilosofÃ­a, Humanidades y Artes</option>
        <option value="Facultad de Arquitectura, Urbanismo y DiseÃ±o">Facultad de Arquitectura, Urbanismo y DiseÃ±o</option>
        <option value="Escuela Universitaria de Ciencias de la Salud">Escuela Universitaria de Ciencias de la Salud</option>
        <option value='IPU - Escuela Industrial "Domingo F. Sarmiento"'>IPU - Escuela Industrial "Domingo F. Sarmiento"</option>
        <option value='IPU - Escuela de Comercio "Lib. Gral. San MartÃ­n"'>IPU - Escuela de Comercio "Lib. Gral. San MartÃ­n"</option>
        <option value='IPU - Colegio Central Universitario "Mariano Moreno"'>IPU - Colegio Central Universitario "Mariano Moreno"</option>
      </select>

      <fieldset style="margin-top:16px; padding:12px; border:1px solid #e0e0e0; border-radius:8px;">
        <legend style="padding:0 6px; color:#1d3557; font-weight:bold;">MenÃºs</legend>

        <label for="comun">ComÃºn / Tradicional</label>
        <input type="number" name="comun" id="comun" min="0" value="0" />

        <label for="celiacos">CelÃ­acos</label>
        <input type="number" name="celiacos" id="celiacos" min="0" value="0" />

        <label for="vegetarianos">Vegetarianos</label>
        <input type="number" name="vegetarianos" id="vegetarianos" min="0" value="0" />

        <label for="veganos">Veganos</label>
        <input type="number" name="veganos" id="veganos" min="0" value="0" />

        <p id="totalMsg" style="margin-top:8px; font-size:14px; color:#333;">
          Total de menÃºs: <b id="totalNum">0</b>
        </p>
        <p id="errorMsg" style="display:none; color:#b00020; font-weight:bold; font-size:14px; margin-top:6px;">
          La cantidad total debe ser al menos 1.
        </p>
      </fieldset>

      <div class="aviso-descuento">
        <h3>Importante</h3>
        <p>Al enviar este formulario, confirmÃ¡s que <strong>aceptÃ¡s el descuento</strong> del total de las opciones seleccionadas directamente por planilla de haberes, <strong>en 4 cuotas iguales.</strong></p>
        <p class="precio-opcion"><strong>El valor de cada menÃº es de $50.000</strong>.</p>
      </div>

      <button type="submit" id="submitBtn" disabled>Enviar</button>
    </form>

    <footer class="footer">
      <p>Â© <span id="anio"></span> Universidad Nacional de San Juan â€“ Rectorado</p>
    </footer>
  </div>

  <script>
    const ENDPOINT_REGISTER = "/api/register";
    const SUPABASE_URL = "https://dlitmctfjzmedssrbazs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaXRtY3RmanptZWRzc3JiYXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTAwNTQsImV4cCI6MjA3NDI4NjA1NH0.ciennL_O5fphj1x_DQ18jW-awBYIWjXRgs5Oxk31TQQ";
    const HEADERS = { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY };

    const dniInput = document.getElementById("dni");
    const nombreInput = document.getElementById("nombre");
    const submitBtn = document.getElementById("submitBtn");
    const fechaLimite = new Date("2025-11-28T23:59:59");

    const comunInput = document.getElementById("comun");
    const celiacosInput = document.getElementById("celiacos");
    const vegetarianosInput = document.getElementById("vegetarianos");
    const veganosInput = document.getElementById("veganos");
    const totalNum = document.getElementById("totalNum");
    const errorMsg = document.getElementById("errorMsg");

    let dniValido = false;

    function int(v) {
      const n = parseInt(v, 10);
      return Number.isNaN(n) ? 0 : n;
    }

    function validarTotal() {
      const total = int(comunInput.value) + int(celiacosInput.value) + int(vegetarianosInput.value) + int(veganosInput.value);
      totalNum.textContent = total;
      const invalido = total < 1;
      errorMsg.style.display = invalido ? "block" : "none";
      submitBtn.disabled = !(dniValido && !invalido);
      return !invalido;
    }

    ["input", "change"].forEach(evt => {
      [comunInput, celiacosInput, vegetarianosInput, veganosInput].forEach(i => {
        i.addEventListener(evt, validarTotal);
      });
    });

    dniInput.addEventListener("blur", async () => {
      if (new Date() > fechaLimite) return;
      const dni = dniInput.value.trim();
      if (!dni) return;

      Swal.fire({ title: "Verificando DNI...", text: "Por favor, esperÃ¡...", didOpen: () => Swal.showLoading(), allowOutsideClick: false });

      const resp = await fetch(`${SUPABASE_URL}/rest/v1/invitados?dni=eq.${dni}`, { headers: HEADERS });
      const data = await resp.json();
      Swal.close();

      if (data.length > 0) {
        const invitado = data[0];
        if (invitado.retiro === true) {
          Swal.fire({ icon: "warning", title: "âš ï¸ Retiro ya registrado", text: "Este DNI ya retirÃ³ su entrada." });
          dniValido = false;
          submitBtn.disabled = true;
          return;
        }
        dniValido = true;
        submitBtn.disabled = !validarTotal();
        Swal.fire({ 
          icon: "success", 
          title: "âœ… DNI validado", 
          timer: 1500, 
          showConfirmButton: false 
        });
        nombreInput.focus();
      } else {
        Swal.fire({ icon: "error", title: "âŒ DNI no habilitado" });
        dniValido = false;
        submitBtn.disabled = true;
      }
    });

    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validarTotal()) {
        Swal.fire({ icon: "error", title: "Error", text: "DebÃ©s seleccionar al menos un menÃº." });
        return;
      }
      const formData = new FormData(e.target);
      const payload = Object.fromEntries(formData.entries());

      Swal.fire({ title: "Registrando...", didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      const res = await fetch(ENDPOINT_REGISTER, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const text = await res.text();
      Swal.close();

      if (res.ok && text.includes("âœ…")) {
        Swal.fire({ icon: "success", title: "Registro exitoso ðŸŽ‰", text });
        e.target.reset(); submitBtn.disabled = true; totalNum.textContent = "0";
      } else {
        Swal.fire({ icon: "error", title: "Hubo un problema", text });
      }
    });

    document.getElementById("anio").textContent = new Date().getFullYear();
  </script>
</body>
</html>
