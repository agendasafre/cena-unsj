<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<title>Check-in ‚Äì Cena üéâ</title>
<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = "https://dlitmctfjzmedssrbazs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaXRtY3RmanptZWRzc3JiYXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTAwNTQsImV4cCI6MjA3NDI4NjA1NH0.ciennL_O5fphj1x_DQ18jW-awBYIWjXRgs5Oxk31TQQ";
const CHECKIN_FN_URL = "https://dlitmctfjzmedssrbazs.functions.supabase.co/checkin"; // Edge Function

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let persona = null;

async function buscar() {
  const dni = document.getElementById('dni').value.trim();
  if (!dni) { alert("Ingres√° DNI"); return; }

  const { data, error } = await supabase
    .from('asistentes')
    .select('*')
    .eq('dni', dni)
    .order('rol', { ascending: true }); // opcional: empleado primero

  if (error || !data?.length) {
    document.getElementById('result').innerHTML = "‚ùå No encontrado";
    persona = null;
    return;
  }
  // Si vuelven varios (empleado + acompa√±antes con mismo DNI ‚Äî no deber√≠a), mostramos el primero
  persona = data[0];

  document.getElementById('result').innerHTML = `
    <p><b>Nombre:</b> ${persona.nombre}</p>
    <p><b>DNI:</b> ${persona.dni}</p>
    <p><b>Rol:</b> ${persona.rol}</p>
    <p><b>Lugar:</b> ${persona.lugar ?? '‚Äî'}</p>
    <p><b>Estado:</b> ${persona.estado}</p>
  `;
}

async function confirmar() {
  if (!persona) { alert("Busc√° primero por DNI"); return; }
  const pin = (document.getElementById('pin').value || "").trim();
  if (!pin) { alert("Ingres√° PIN"); return; }

  const res = await fetch(CHECKIN_FN_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ dni: persona.dni, pin })
  });
  const text = await res.text();
  document.getElementById('out').textContent = (res.ok ? "‚úÖ Asistencia registrada" : "‚ùå " + text);
  if (res.ok) { await buscar(); } // refresca estado
}

async function noIdentificado() {
  if (!persona) { alert("Busc√° primero por DNI"); return; }
  // No pide PIN: operativa r√°pida para rechazar
  const res = await fetch(CHECKIN_FN_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ dni: persona.dni, pin: 'OVERRIDE_WITH_CORRECT_PIN_ON_SERVER', estado: 'no_identificado' })
  });
  // NOTA: Para que esto funcione sin PIN, podr√≠as crear otra funci√≥n edge con secreto distinto,
  // o manejar un segundo PIN de rechazo. Lo dejamos protegido por el mismo PIN por seguridad.
  const text = await res.text();
  document.getElementById('out').textContent = (res.ok ? "‚ùå Marcado como no identificado" : "‚ùå " + text);
  if (res.ok) { await buscar(); }
}

window.buscar = buscar;
window.confirmar = confirmar;
window.noIdentificado = noIdentificado;
</script>
<style>
body { font-family: system-ui, Arial; max-width: 600px; margin: 24px auto; }
#panel { display:flex; gap:8px; align-items:center; }
button { padding:8px 12px; }
.card { border:1px solid #ddd; padding:12px; border-radius:8px; margin-top:10px; }
</style>
</head>
<body>
<h1>Check-in</h1>

<div id="panel">
  <input id="dni" placeholder="DNI" />
  <button onclick="buscar()">Buscar</button>
</div>

<div id="result" class="card">‚Äî</div>

<div class="card">
  <p>PIN de controlador:</p>
  <input id="pin" type="password" placeholder="PIN" />
  <button onclick="confirmar()">‚úÖ Confirmar ingreso</button>
  <button onclick="noIdentificado()">‚ùå No identificado</button>
</div>

<div id="out" style="margin-top:8px; font-weight:bold;"></div>
</body>
</html>
