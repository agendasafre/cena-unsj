<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sorteo ‚Äì Cena de Fin de A√±o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- SweetAlert2 para mensajes -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      /* üé® Colores del gradiente (cambiables sin tocar m√°s nada) */
      --g1: #0d47a1; /* azul profundo */
      --g2: #1976d2; /* azul medio */
      --g3: #ffffff; /* blanco */
    }

    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      color: #fff;
      overflow: hidden; /* pantalla limpia para proyector */
      background: linear-gradient(130deg, var(--g1), var(--g2), var(--g3));
      background-size: 200% 200%;
      animation: bgMove 14s ease-in-out infinite;
    }

    @keyframes bgMove {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .wrap {
      position: relative;
      height: 100%;
      width: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
      align-items: center;
      justify-items: center;
      padding: 24px;
      box-sizing: border-box;
    }

    .logo {
      width: clamp(100px, 12vw, 160px);
      height: auto;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.25));
      margin-top: 4px;
    }

    .title {
      margin: 10px 0 0;
      font-weight: 600;
      letter-spacing: .4px;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      opacity: .95;
    }

    .slot {
      position: relative;
      width: min(900px, 92vw);
      height: clamp(80px, 10vw, 120px);
      margin-top: clamp(18px, 3vh, 30px);
      border-radius: 14px;
      background: rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 25px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.2);
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .slot__text {
      font-size: clamp(24px, 4vw, 44px);
      font-weight: 700;
      text-align: center;
      padding: 0 18px;
      line-height: 1.2;
      text-shadow: 0 4px 12px rgba(0,0,0,.35);
      white-space: nowrap;
    }

    .controls {
      margin-top: clamp(18px, 3vh, 26px);
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      font-size: clamp(16px, 2.2vw, 20px);
      padding: 12px 22px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      color: #0d2b57;
      background: #dbecfa; /* celeste suave */
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease, background .3s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.28); }
    .btn:active { transform: translateY(0); box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; filter: grayscale(.2); }

    .footer {
      margin-top: 14px;
      font-size: clamp(12px, 1.6vw, 14px);
      opacity: .85;
      text-shadow: 0 2px 8px rgba(0,0,0,.25);
    }

    /* üèÜ Overlay de ganador */
    .winner {
      position: fixed;
      inset: 0;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.15), rgba(0,0,0,.55));
      display: none;
      place-items: center;
      z-index: 10;
      backdrop-filter: blur(2px);
    }
    .winner.show { display: grid; }

    .winner__card {
      text-align: center;
      max-width: min(1200px, 90vw);
      padding: clamp(18px, 4vw, 34px);
      border-radius: 18px;
      background: rgba(255,255,255,.1);
      box-shadow: 0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.25);
      animation: popIn .6s cubic-bezier(.17,.67,.2,1.2);
    }
    @keyframes popIn {
      from { transform: scale(.92); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }

    .winner__pre {
      font-size: clamp(22px, 3.2vw, 36px);
      margin: 0 0 8px;
      opacity: .95;
      text-shadow: 0 2px 10px rgba(0,0,0,.3);
    }
    .winner__name {
      font-size: clamp(40px, 7vw, 92px);
      font-weight: 800;
      margin: 6px 0 0;
      line-height: 1.05;
      letter-spacing: .4px;
      text-shadow: 0 8px 28px rgba(0,0,0,.35);
    }
    .winner__place {
      font-size: clamp(18px, 2.6vw, 28px);
      margin: 14px 0 0;
      opacity: .95;
      text-shadow: 0 4px 14px rgba(0,0,0,.3);
    }

    /* ‚ú® Confetti sutil (CSS-only dots) */
    .confetti {
      position: fixed; inset: 0; pointer-events: none; overflow: hidden;
    }
    .dot {
      position: absolute; width: 8px; height: 8px; border-radius: 50%;
      opacity: .85; filter: drop-shadow(0 2px 2px rgba(0,0,0,.25));
      animation: fall linear forwards;
    }
    @keyframes fall {
      from { transform: translateY(-10vh) rotate(0deg); }
      to   { transform: translateY(110vh) rotate(480deg); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center;">
      <img src="./assets/logo.webp" alt="Logo" class="logo" />
      <h2 class="title">Sorteo ‚Äì Cena de Fin de A√±o</h2>
    </div>

    <!-- üé∞ Slot visual -->
    <div class="slot">
      <div id="slotText" class="slot__text">Listo para sortear‚Ä¶</div>
    </div>

    <!-- üéõÔ∏è Controles -->
    <div class="controls">
      <button id="btnStart" class="btn">üé≤ Iniciar sorteo</button>
    </div>
  </div>

  <!-- üèÜ Overlay de ganador -->
  <div id="winner" class="winner">
    <div class="winner__card">
      <div class="winner__pre">üëè Aplausos para‚Ä¶</div>
      <div id="winnerName" class="winner__name">Nombre Apellido</div>
      <div id="winnerPlace" class="winner__place">Lugar de trabajo</div>
      <div class="controls" style="margin-top:22px;">
        <button id="btnNext" class="btn">üé≤ Sortear otro</button>
      </div>
    </div>
    <div id="confetti" class="confetti" aria-hidden="true"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* üîå Conexi√≥n Supabase */
    const SUPABASE_URL = "https://dlitmctfjzmedssrbazs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaXRtY3RmanptZWRzc3JiYXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTAwNTQsImV4cCI6MjA3NDI4NjA1NH0.ciennL_O5fphj1x_DQ18jW-awBYIWjXRgs5Oxk31TQQ";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ‚è±Ô∏è Config animaci√≥n */
    const DURATION_MS = 4500;   // 4.5s como pediste
    const TICK_MIN_MS = 45;     // m√≠nimo entre cambios de nombre al final
    const TICK_MAX_MS = 120;    // m√°ximo al inicio (m√°s r√°pido = menor valor)

    /* üî§ UI refs */
    const slotText   = document.getElementById("slotText");
    const btnStart   = document.getElementById("btnStart");
    const winnerEl   = document.getElementById("winner");
    const winnerName = document.getElementById("winnerName");
    const winnerPlace= document.getElementById("winnerPlace");
    const btnNext    = document.getElementById("btnNext");
    const confettiEl = document.getElementById("confetti");

    let running = false;

    const sleep = (ms) => new Promise(res => setTimeout(res, ms));

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function easeOutQuad(t) {
      return t * (2 - t);
    }

    function setSlotDisplay(persona) {
      slotText.textContent = `${persona.nombre} ‚Äî ${persona.lugar_trabajo || "‚Äî"}`;
    }

    async function fetchElegibles() {
      const { data, error } = await supabase
        .from("invitados")
        .select("id, nombre, lugar_trabajo")
        .eq("retiro", true)
        .eq("estado", "inscripto")
        .eq("sorteado", false);

      if (error) throw error;
      return data || [];
    }

    function showWinner(persona) {
      winnerName.textContent = persona.nombre;
      winnerPlace.textContent = persona.lugar_trabajo || "‚Äî";
      winnerEl.classList.add("show");
      fireConfetti(); // üéâ sutil
    }

    function hideWinner() {
      winnerEl.classList.remove("show");
      clearConfetti();
    }

    function fireConfetti() {
      clearConfetti();
      const colors = ["#fff176", "#a5d6a7", "#81d4fa", "#f48fb1", "#ffd54f", "#b39ddb"];
      const total = 80;
      for (let i = 0; i < total; i++) {
        const d = document.createElement("div");
        d.className = "dot";
        d.style.left = Math.random()*100 + "vw";
        d.style.top  = (-10 - Math.random()*30) + "vh";
        d.style.background = colors[Math.floor(Math.random()*colors.length)];
        d.style.animationDuration = (4 + Math.random()*3) + "s";
        d.style.animationDelay = (Math.random()*0.6) + "s";
        confettiEl.appendChild(d);
      }
    }
    function clearConfetti() {
      confettiEl.innerHTML = "";
    }

    async function marcarSorteado(id) {
      const { error } = await supabase
        .from("invitados")
        .update({ sorteado: true })
        .eq("id", id);
      if (error) {
        console.error(error);
        Swal.fire("‚ö†Ô∏è Error", "No se pudo actualizar el ganador en la base.", "warning");
      }
    }

    async function startSorteo() {
      if (running) return;
      running = true;
      btnStart.disabled = true;
      hideWinner();

      let elegibles;
      try {
        elegibles = await fetchElegibles();
      } catch (e) {
        running = false;
        btnStart.disabled = false;
        return Swal.fire("Error", "No se pudo consultar la base de datos.", "error");
      }

      if (!elegibles.length) {
        running = false;
        btnStart.disabled = false;
        return Swal.fire("Sin elegibles", "No quedan personas disponibles para el sorteo.", "info");
      }

      // barajamos para mostrar variedad en la ruleta
      let pool = shuffle([...elegibles]);

      const start = performance.now();
      let lastIdx = 0;

      // bucle de ‚Äúruleta‚Äù con easing
      while (true) {
        const now = performance.now();
        const t = Math.min(1, (now - start) / DURATION_MS);          // 0..1
        const speed = TICK_MAX_MS - (TICK_MAX_MS - TICK_MIN_MS) * easeOutQuad(t);
        const idx = Math.floor((now / speed)) % pool.length;
        if (idx !== lastIdx) {
          setSlotDisplay(pool[idx]);
          lastIdx = idx;
        }
        if (t >= 1) break;
        // micro-sleep para no saturar
        // (no usamos await sleep(speed) para no perder fluidez con easing)
        await sleep(16);
      }

      // ganador real (no necesariamente el √∫ltimo que se mostr√≥, para evitar sesgos)
      const ganador = elegibles[Math.floor(Math.random() * elegibles.length)];

      // Revelamos al ganador con mini ‚Äúruleta final‚Äù
      for (let i = 0; i < 12; i++) {
        setSlotDisplay(pool[(lastIdx + i) % pool.length]);
        await sleep(55 + i*8);
      }
      setSlotDisplay(ganador);

      // Mostrar overlay y marcar en la base
      showWinner(ganador);
      await marcarSorteado(ganador.id);

      // Habilitamos ‚ÄúSortear otro‚Äù
      btnNext.disabled = false;
      running = false;
    }

    async function nextRound() {
      btnNext.disabled = true;
      hideWinner();
      slotText.textContent = "Listo para sortear‚Ä¶";
      // Reiniciamos el estado y lanzamos directamente el siguiente sorteo
      await sleep(500); // peque√±o respiro visual
      startSorteo();
    }

    // Eventos
    btnStart.addEventListener("click", startSorteo);
    btnNext.addEventListener("click", nextRound);
  </script>
</body>
</html>
